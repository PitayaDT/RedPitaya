<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LCR meter</title>
  <link href="../assets/bootstrap-3.0.0/css/bootstrap.css" rel="stylesheet" type="text/css">
  <link href="../assets/style.css?6" rel="stylesheet" type="text/css">
  <script src="../assets/bootstrap-3.0.0/js/jquery.js"></script>
  <script src="../assets/bootstrap-3.0.0/js/bootstrap.min.js"></script>
  <script src="../assets/flot/jquery.flot.min.js"></script>
  <script src="../assets/flot/jquery.flot.selection.min.js"></script>
  <script src="../assets/flot/jquery.flot.navigate.js"></script>
  <script src="../assets/flot/jquery.flot.resize.min.js"></script>
  <script src="../assets/flot/jquery.flot.touch.js?2"></script>
  <script type="text/javascript">
  
  // Settings which can be modified
   
  var app_id = 'lcr_meter';  
  var root_url = '';
  //var root_url = 'http://10.0.1.221';      // Test local
  //var root_url = 'http://192.168.53.133';  // Test remote and local
  //var root_url = 'http://192.168.1.100';   // Default RedPitaya IP
  var start_app_url = root_url + '/bazaar?start=' + app_id;
  var stop_app_url = root_url + '/bazaar?stop=';
  var get_url = root_url + '/data';
  var post_url = root_url + '/data';
  var upload_url = root_url + '/upload_gen_ch';  // The channel number is added automatically
  
  var update_interval = 50;              // Update interval for PC, milliseconds
  var update_interval_mobdev = 500;      // Update interval for mobile devices, milliseconds 
  var request_timeout = 3000;            // Milliseconds
  var long_timeout = 20000;              // Milliseconds
  var meas_panel_dec = 5;                // Decimation for numerical measure panel to make it human readable
  var meas_panel_dec_mobdev = 1;         // Decimation for numerical measure panel for mobile devices
  var points_per_px = 5;                 // How many points per pixel should be drawn. Set null for unlimited (will disable client side decimation).
  var xdecimal_places = 2;               // Number of decimal places for the xmin/xmax values. Maximum supported are 12.
  var trigger_level_xdecimal_places = 4; // Number of decimal places for trigger level tooltip
  var range_offset = 1;                  // Percentages
    
  var xmin = -1000000;
  var xmax = 1000000;  

  /* LCR data type. 0 - phase, 1 - amplitude */
  var data_type = 1;
  var lcr_modal;
  var input_control = 0;
  var lcr_modal;
  var change_Measure = 0;

  var range_steps = [0];
  
  var plot_options = {
    colors: ['#3276B1', '#D2322D', '#009900'],    // channel1, channel2, trigger line
    lines: { lineWidth: 1 },
    xaxis: { min: xmin, max: xmax },
    grid: { borderWidth: 0, hoverable: true, clickable: true, autoHighlight: true },
    legend: { noColumns: 2, margin: [0, 0], backgroundColor: 'transparent' },
    touch: { autoWidth: false, autoHeight: false }
  };
  
  var counter = 0;
  // Settings which should not be modified
  
  var update_timer = null;
  var zoompan_timer = null;
  var downloading = false;
  var sending = false;
  var send_que = false;
  var use_long_timeout = false;
  var trig_dragging = false;
  var touch_last_y = 0;
  var user_editing = false;
  var app_started = false;
  var last_get_failed = false;
  var refresh_counter = 0;
  var autorun = 1;
  var datasets = [];
  var plot = null;
  var params = {
    original: null,
    local: null
  };
  
  // Default parameters - posted after server side app is started 
  var def_params = {
    en_avg_at_dec: 0
  }; 
    
  // On page loaded
  
  $(function() {
    
    // Show different buttons on touch screens    
    if(window.ontouchstart === undefined) { //If we aren't in a touch environment
      $('.btn-lg').removeClass('btn-lg');
      $('#accordion .btn, .modal .btn').addClass('btn-sm');
      $('#btn_zoompan').remove();
      $('#btn_zoomin, #btn_zoomout, #btn_pan').hide(); //comment .show()
    }

    //Here we are in a tablet or a mobile phone
    else {
      update_interval = update_interval_mobdev;
      meas_panel_dec = meas_panel_dec_mobdev;
      //Remove all these buttons, as the zooming and panning is done by finger
      $('#btn_zoomin, #btn_zoomout, #btn_pan').remove();
      $('#btn_zoompan').show();
    }
    
    // Add application ID in the message from modal popup. If we started an app else-where
    $('.app-id').text(app_id);
    
    // Disable all controls until the params state is loaded for the first time 
    $('input, select, button', '.container').prop('disabled', true);
      
    // Modals -- TODO: Put everything in a function.
    
    $('#modal_err, #modal_app').modal({ show: false, backdrop: 'static', keyboard: false });
    $('#modal_upload').modal({ show: false });
    
    $('#btn_switch_app').on('click', function() {
      var newapp_id = $('#new_app_id').text();
      if(newapp_id.length) {
        location.href = location.href.replace(app_id, newapp_id);
      }
    });
    
    $('.btn-app-restart').on('click', function() {
      location.reload();
    });
    
    $('#btn_retry_get').on('click', function() {
      $('#modal_err').modal('hide');
      updateGraphData();
    });
    
    $('.btn-close-modal').on('click', function() {
      $(this).closest('.modal').modal('hide');
    });


    /*
    $("#plot_holder").bind("plotclick", function (event, pos, item) {
      window.alert(pos.y / 0.01);
    });
    
    */


    // Reset the upload form to prevent browser caching of the uploaded file name
    $('#upload_form')[0].reset();
      
    // Other event bindings
    
    $('#trigger_tooltip').tooltip({
      title: '',
      trigger: 'manual',
      placement: 'auto left',
      animation: false
    });
    
    $('.btn').on('click', function() {
      var btn = $(this);
      setTimeout(function() { btn.blur(); }, 10);
    });
    
    $('#btn_toolbar .btn').on('blur', function() {
      $(this).removeClass('active');
    });
    
    $(document).on('click', '#accordion > .panel > .panel-heading', function(event) {
      $(this).next('.panel-collapse').collapse('toggle');
      event.stopImmediatePropagation();
    });
    
    // Tooltips for range buttons
    $('#range_x_minus, #range_x_plus, #range_y_minus, #range_y_plus').tooltip({
      container: 'body'
    });


    
    
    // Load first data
    updateGraphData();
    
    // Stop the application when page is unloaded
    window.onbeforeunload = function() { 
      $.ajax({
        url: stop_app_url,
        async: false
      });
    };

  });
  

  

  function startApp() {
    $.get(
      start_app_url
    )

    .done(function(dresult) {
      if(dresult.status == 'ERROR') {
        //If we get an error, show a modal
        showModalError((dresult.reason ? dresult.reason : 'Could not start the application.'), true);
      }
      //Else, unpack the JSON strucuture
      else {
        $.post(
          post_url, 
          JSON.stringify({ datasets: { params: def_params } })
        )
        //When we are done. 
        .done(function(dresult) {
          app_started = true;
          updateGraphData();      
        })
        //If the unpacking failed
        .fail(function() {
          showModalError('Could not initialize the application with default parameters.', false, true);
        });
      }
    })
    //If we can't even get to the status
    .fail(function() {
      showModalError('Could not start the application.', true);
    });
  }
  
  function showModalError(err_msg, retry_btn, restart_btn, ignore_btn) {
    var err_modal = $('#modal_err');

    //If any of the buttons are given, show them. Else hide them.
    err_modal.find('#btn_retry_get')[retry_btn ? 'show' : 'hide']();
    err_modal.find('.btn-app-restart')[restart_btn ? 'show' : 'hide']();
    err_modal.find('#btn_ignore')[ignore_btn ? 'show' : 'hide']();
    err_modal.find('.modal-body').html(err_msg);
    //Show our modal
    err_modal.modal('show');
  }   
  
  function updateGraphData() {
    //If we are currently downloading data. False by default.
    if(downloading) {
      return;
    }


    if(update_timer) {
      clearTimeout(update_timer);
      update_timer = null;
    }
    downloading = true;
    
    // Send params if there are any unsent changes
    sendParams();
    
    //?
    var arun_before_ajax = autorun;
    var long_timeout_used = use_long_timeout;
    
    $.ajax({
      url: get_url,
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    //?

    //What do we do, when we are done downloading the JSON package.
    .done(function(dresult) {
      last_get_failed = false;
      
      //If we got an error
      if(dresult.status === 'ERROR') {

        //If app wasn't started yet.
        if(!app_started) {
          startApp();
        }
        //Else, show modal.
        else {
          showModalError((dresult.reason ? dresult.reason : 'Application error.'), true, true);
        }

      }


      else if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
        
        // Check if the application started on the server is the same as on client
        if(app_id !== dresult.app.id) {
          if(!app_started) {
            startApp();
          }
          //If we didn't start the same app, show a modal.
          else {
            $('#new_app_id').text(dresult.app.id);
            $('#modal_app').modal('show');
          }
          return;
        }
        
        app_started = true;
      
        // Check if trigger mode (which may switch autorun) was changed during ajax request
        var arun_after_ajax = autorun;
        
        datasets = [];

        for(var i=0; i<dresult.datasets.g1.length; i++) {
          dresult.datasets.g1[i].color = i;
          dresult.datasets.g1[i].label = 'Channel ' + (i+1);          
          datasets.push(dresult.datasets.g1[i]);
        }
        
        if(! plot) {
          initPlot(dresult.datasets.params);
        }
        else {
          // Apply the params state received from server if not in edit mode
          if(! user_editing) {
            loadParams(dresult.datasets.params);
            
            // Restore the autorun value modified by loadParams 
            if(arun_before_ajax != arun_after_ajax) {
              autorun = arun_after_ajax; 
            }
          }
          // Time units must be always updated
          else {
            updateTimeUnits(dresult.datasets.params);
          }
          
          // Force X min/max
          if(dresult.datasets.params.forcex_flag == 1) {
            var options = plot.getOptions();
            options.xaxes[0].min = dresult.datasets.params.xmin;
            options.xaxes[0].max = dresult.datasets.params.xmax;
          }
          
          // Redraw the plot using new datasets 
          plot.setData(filterData(datasets, plot.width()));
          plot.setupGrid();
          plot.draw();
        }
        
        updateRanges();

        if(autorun || dresult.status === 'AGAIN') {
          if(autorun) {
            $('#btn_single').prop('disabled', true);
          }

          update_timer = setTimeout(function() {
            updateGraphData();
          }, update_interval);
        }
        else {
          $('#btn_single').prop('disabled', false);
        }
      }
      
      else {
        //msg, retry, restart
        showModalError('Wrong application data received.', true, true);
      }
    })

    .fail(function(jqXHR, textStatus, errorThrown) {
      if(last_get_failed) {
        showModalError('Data receiving failed.<br>Error status: ' + textStatus, true, true);
        last_get_failed = false;
      }
      else {
        last_get_failed = true;
        downloading = false;
        updateGraphData();  // One more try
      }
    })

    .always(function() {
      if(!last_get_failed) {
        downloading = false;
          
          // Manage the state of other components
          $('#accordion').find('input,select').prop('disabled', false);
          $('.btn').prop('disabled', false);
        }

      if(long_timeout_used) {
        use_long_timeout = false;
      }
      
    });

    //Autoscale every result we get (For LCR purposes)
    autoscaleY();

  }
  
  function initPlot(init_params) {
    var plot_holder = $('#plot_holder');

    //Calculated by the program and is read-only
    var ymax = init_params.gui_reset_y_range / 2;
    var ymin = ymax * -1;
    
    // Load received params
    loadParams(init_params);
    
    // When xmin/xmax are null, the min/max values of received data will be used. For ymin/ymax use the gui_reset_y_range param.
    $.extend(true, plot_options, {
      xaxis: { min: null, max: null },
      yaxis: { min: ymin, max: ymax }
    });
    
    // Local optimization - signal data
    var filtered_data = filterData(datasets, plot_holder.width());
  
    // Plot first creation and drawing
    plot = $.plot(
      plot_holder, 
      filtered_data,
      plot_options
    );

    //In this function, we can do the zooming. But LCR doesn't have the functionality enabled in version 0.93-1
  }
  
  function onDropdownChange(that, param_name, do_get) {
    params.local[param_name] = parseInt(that.val());
    sendParams(do_get);
    that.blur();
    user_editing = false;
  }
  
  function loadParams(orig_params) {
    if(! $.isPlainObject(orig_params)) {
      return;
    }
    
    // Ignore xmin/xmax values received from server. Those values must be used only on AUTO button click 
    // and on ForceX flag, but that is done before the sendParams() function is called.
    if(plot) {
      var options = plot.getOptions();
      if(options.xaxes[0].min && options.xaxes[0].max) {
        orig_params.xmin = options.xaxes[0].min;
        orig_params.xmax = options.xaxes[0].max;
      }
    }
    
    // Same data in local and original params
    params.original = $.extend({}, orig_params);
    params.local = $.extend({}, params.original);
    
    updateTimeUnits(orig_params);

    $('#ytitle').show();
  }


  //********* axis!!!  apply_Yaxis  var freq = document.getElementById("info_ch1_freq").innerHTML;
  function updateTimeUnits(new_params) {

    
    /* Load new param data */
    if(params.local.lcr_save_data == 3){
      document.getElementById("gen_fs_Sfreq").value = params.local.start_freq;

      document.getElementById('gen_amp').value = params.local.gen_amp;
      document.getElementById('gen_avg').value = params.local.gen_avg;
      document.getElementById('gen_DC_bias').value = params.local.gen_DC_bias;;
      document.getElementById('gen_R_shunt').value = params.local.gen_R_shunt;
      document.getElementById('gen_fs_Efreq').value = params.local.end_freq;
      document.getElementById('gen_fs_LoadIm').value = params.local.gen_fs_LoadIm;
      document.getElementById('gen_fs_LoadRe').value = params.local.gen_fs_LoadRe;  

      params.local.lcr_save_data = 0;
      sendParams();
      
    }
    

    if(params.local.start_measure == 0){
      lcr_modal.hidePleaseWait();
      var show_lcr_channel = $('#btn_ch1');
      show_lcr_channel.data('checked', true);

      /* Table proprieties */
      var t_m = document.getElementById('t_measurment_data');
      t_m.style.display = 'block';
    }

    if(! $.isPlainObject(new_params)) {
      return;
    } 
    
    params.original.time_units = params.local.time_units = new_params.time_units;
  
    if(change_Measure == 1)
    {

      var di = document.getElementById("apply_Yaxis").selectedIndex;
      var ytitl = document.getElementById("apply_Yaxis").options[di].text;

      /* Set Y tittle */
      $('#ytitle').text(ytitl);

      var id = document.getElementById("apply_Xaxis").selectedIndex;
      var xtitl = document.getElementById("apply_Xaxis").options[id].text;

      /* Set X tittle */
      $('#xtitle').text(xtitl);

      /* We don't want to IF everytime */
      change_Measure = 0;
    }

  
  }
  
  function isParamChanged() {
    
    if(params.original) {
      for(var key in params.original) {
        if(params.original[key] != params.local[key]) {
          return true;
        }
      }
    }
  return false;
  }
  
  function sendParams(refresh_data, force_send, single_btn) {
    if(sending || (force_send !== true && !isParamChanged())) {
      send_que = sending;
      return;
    }
    
    var auto_flag = params.local.auto_flag;  // Keep the value of auto_flag, because in POST response it is always 0
    sending = true;
    params.local.single_btn = 1; // We don't have a single button in LCR, but always just need one measurment, so single_btn is always 1.
    use_long_timeout = !!auto_flag;
    
    //Issue a post request
    $.ajax({
      type: 'POST',
      url: post_url,
      data: JSON.stringify({ datasets: { params: params.local } }),
      timeout: (use_long_timeout ? long_timeout : request_timeout),
      cache: false
    })
    //Succesfuly loaded
    .done(function(dresult) {
      // OK: Load the params received as POST result
      if(dresult.datasets !== undefined && dresult.datasets.params !== undefined) {
      
        // Use the provided min/max values only once after AUTO button was clicked
        if(auto_flag == 1 && dresult.datasets.params.min_y !== dresult.datasets.params.max_y) {
          var options = plot.getOptions();
          
          options.xaxes[0].min = dresult.datasets.params.xmin;
          options.xaxes[0].max = dresult.datasets.params.xmax;
          options.yaxes[0].min = dresult.datasets.params.min_y;
          options.yaxes[0].max = dresult.datasets.params.max_y;

          //Lets do a quick redraw
          plot.setupGrid();
          plot.draw();
          }
        
      
        if(auto_flag == 0 && dresult.datasets.params.forcex_flag == 1) {
          var options = plot.getOptions();
          
          options.xaxes[0].min = dresult.datasets.params.xmin;
          options.xaxes[0].max = dresult.datasets.params.xmax;
         
          plot.setupGrid();
          plot.draw();
        }      
      
        loadParams(dresult.datasets.params);
                
        if(refresh_data && !downloading) {
          updateGraphData();
        } 
      }

      else if(dresult.status == 'ERROR') {
        showModalError((dresult.reason ? dresult.reason : 'Error while sending data (E1).'), false, true, true);
        send_que = false;
      }
      else {
        showModalError('Error while sending data (E2).', false, true, true);
      }
    })
    .fail(function() {
      showModalError('Error while sending data (E3).', false, true, true);
    })
    .always(function() {
      sending = false;
      user_editing = false;
      
      if(send_que) {
        send_que = false;
        setTimeout(function(refresh_data) {
          sendParams(refresh_data);
        }, 100);
      }
    });
  }
  
  //This function plots only the defined data.
  function getData(from, to) {
    var rangedata = new Array();

    for(var i=0; i<datasets.length; i++) {
      
      //If the channel isn't checked - So we can skip channel 2 in our case.
      if(!$('#btn_ch' + (i+1)).data('checked')) {
        continue;
      }

      rangedata.push({ color: datasets[i].color, label: datasets[i].label, data: [] });

      for(var j=0; j < datasets[i].data.length; j++) {
        if(datasets[i].data[j][0] > to) {
          break;
        }
        if(datasets[i].data[j][0] >= from) {
          rangedata[rangedata.length - 1].data.push(datasets[i].data[j]);
        }
      }
    }
    rangedata = filterData(rangedata, (plot ? plot.width() : $('plot_holder').width()));


    return rangedata;
  }
  
  // Use only data for selected channels and do downsampling (data decimation), which is required for 
  // better performance. Too many points cannot be shown on the canvas. 
  function filterData(dsets, points) {
    var filtered = [];
    var num_of_channels = 2;

    for(var l=0; l<num_of_channels; l++) {
      if(! $('#btn_ch' + (l+1)).data('checked')) {
        continue;
      }

      i = Math.min(l, dsets.length - 1);

      filtered.push({ color: dsets[i].color, label: dsets[i].label, data: [] });
      
      if(points_per_px === null || dsets[i].data.length > points * points_per_px) {
        var step = Math.ceil(dsets[i].data.length / (points * points_per_px));
        var k = 0;
        for(var j=0; j<dsets[i].data.length; j++) {
          if(k > 0 && ++k < step) {
            continue;
          }
          filtered[filtered.length - 1].data.push(dsets[i].data[j]);
          k = 1;
        }
      }
      else {
        filtered[filtered.length - 1].data = dsets[i].data.slice(0);
      }
    }
    
    //filtered = addTriggerDataSet(filtered);
    return filtered;
  }
  
  function redrawPlot() {
    if(! downloading) {
      if(! plot) {
        updateGraphData();
      }
      else {
        var options = plot.getOptions();
        plot = $.plot(
          plot.getPlaceholder(), 
          filterData(datasets, plot.width()),
          $.extend(true, plot_options, {
            xaxis: { min: options.xaxes[0].min, max: options.xaxes[0].max },
            yaxis: { min: options.yaxes[0].min, max: options.yaxes[0].max }
          })
        );
               
      }
    }
  }
  
  
  function autoscaleY() {
    if(! plot) {
      return;
    }
    
    var options = plot.getOptions();
    var axes = plot.getAxes();
    
    // Set Y scale to data min/max + 10%
    options.yaxes[0].min = (axes.yaxis.datamin < 0 ? axes.yaxis.datamin * 1.1 : axes.yaxis.datamin - axes.yaxis.datamin * 0.1); 
    options.yaxes[0].max = (axes.yaxis.datamax > 0 ? axes.yaxis.datamax * 1.1 : axes.yaxis.datamax + axes.yaxis.datamax * 0.1);

    plot.setupGrid();
    plot.draw();
    
    updateRanges();
    //updateTriggerSlider();
  }
  

  /* This function serves for plotting graph data and zooming-in */
  function updateRanges() {
    var xunit = 'Hz'
    var yunit = '';
    /*Get the axes*/
    var axes = plot.getAxes();

    /* Plot range on the graph */
    var xrange = axes.xaxis.max - axes.xaxis.min;
    var yrange = axes.yaxis.max - axes.yaxis.min;

    var yminrange = 1000;  // 
    var ymaxrange = 1000;
    var xmaxrange = params.original.end_freq;  // Herth
    var xminrange = params.local.start_freq - params.original.start_freq;
    
    var decimals = 1;

    if(xrange < 1) {
      decimals = 1;
    }

    var seconds = (xunit == 'ns' ? 1e-9 : ( xunit == 'μs' ? 1e-6 : (xunit == 'ms' ? 1e-3 : 1)));

    $('#range_x').html(+(Math.round(xrange + "e+" + decimals) + "e-" + decimals) + ' ' + xunit);
    $('#range_y').html(Math.floor(yrange) + ' ' + yunit);
    
    var nearest_x = getNearestRanges(xrange);
    var nearest_y = getNearestRanges(yrange);
        
    // X limitations 
    if(nearest_x.next * seconds > xmaxrange) {
      nearest_x.next = null;
      $('#range_x_plus').prop('disabled', true);
    }
    else {
      $('#range_x_plus').prop('disabled', false);
    }
    if(nearest_x.prev * seconds < xminrange) {
      nearest_x.prev = null;
      $('#range_x_minus').prop('disabled', true);
    }
    else {
      $('#range_x_minus').prop('disabled', false);
    }
    
    $('#range_x_minus').data({ nearest: nearest_x.prev, unit: xunit }).data('bs.tooltip').options.title = nearest_x.prev;
    $('#range_x_plus').data({ nearest: nearest_x.next, unit: xunit }).data('bs.tooltip').options.title = nearest_x.next;
    
    // Y limitations
    if(nearest_y.next - nearest_y.prev >= ymaxrange) {
      nearest_y.next = null;
      $('#range_y_plus').prop('disabled', true);
    }
    else {
      $('#range_y_plus').prop('disabled', false);
    }
    if(nearest_y.prev < yminrange) {
      nearest_y.prev = null;
      $('#range_y_minus').prop('disabled', true);
    }
    else {
      $('#range_y_minus').prop('disabled', false);
    }
    
    $('#range_y_minus').data({ nearest: nearest_y.prev, unit: yunit }).data('bs.tooltip').options.title = nearest_y.prev;
    $('#range_y_plus').data({ nearest: nearest_y.next, unit: yunit }).data('bs.tooltip').options.title = nearest_y.next;
  }
  
  function getNearestRanges(number) {
    var log10 = Math.floor(Math.log(number) / Math.LN10); 
    var normalized = number / Math.pow(10, log10);    
    var i = 0;
    var prev = null;
    var next = null;
    
    while(i < range_steps.length - 1) {
      var ratio = range_steps[i+1] / normalized;
      if(ratio > 0.99 && ratio < 1.01) {
        prev = range_steps[i];
        next = range_steps[i+2];
        break;
      }
      if(range_steps[i] < normalized && normalized < range_steps[i+1]) {
        prev = range_steps[i];
        next = range_steps[i+1];
        break;
      }
      i++;
    }

    return { 
      prev: prev * Math.pow(10, log10), 
      next: next * Math.pow(10, log10) 
    };
  }
  
  function serverAutoScale() {
    params.local.auto_flag = 1;
    sendParams(true);
  }

  function getLocalDecimalSeparator() {
    var n = 1.1;
    return n.toLocaleString().substring(1,2);
  }
  
  function parseLocalFloat(num) {
    return +(num.replace(getLocalDecimalSeparator(), '.'));
  }
  
  function floatToLocalString(num) {
    // Workaround for a bug in Safari 6 (reference: https://github.com/mleibman/SlickGrid/pull/472)
    //return num.toString().replace('.', getLocalDecimalSeparator());
    return (num + '').replace('.', getLocalDecimalSeparator());
  }
  
  function shortenFloat(value) {
    return value.toFixed(Math.abs(value) >= 10 ? 1 : 3);
  }
 
  function startMeasure(clicked_measure){

    /* Set inputs back to GRAY */
    document.getElementById('gen_R_shunt').style.borderColor = "#cccccc";
    document.getElementById('gen_avg').style.borderColor = "#cccccc";
    document.getElementById('gen_DC_bias').style.borderColor = "#cccccc";
    document.getElementById('gen_amp').style.borderColor = "#cccccc";
    document.getElementById('gen_fs_step').style.borderColor = "#cccccc";
    document.getElementById('gen_fs_Sfreq').style.borderColor = "#cccccc";
    document.getElementById('gen_fs_Efreq').style.borderColor = "#cccccc";
    document.getElementById('gen_fs_LoadIm').style.borderColor = "#cccccc";
    document.getElementById('gen_fs_LoadRe').style.borderColor = "#cccccc";
    document.getElementById('gen_ms_step').style.borderColor = "#cccccc";
    document.getElementById('gen_ms_freq').style.borderColor = "#cccccc";
    document.getElementById('gen_ms_LoadIm').style.borderColor = "#cccccc";
    document.getElementById('gen_ms_LoadRe').style.borderColor = "#cccccc";

    /* General parameters for both MS and FS */
    var amp = parseLocalFloat(document.getElementById('gen_amp').value);
    var avg = parseLocalFloat(document.getElementById('gen_avg').value);
    var dc_bias = parseLocalFloat(document.getElementById('gen_DC_bias').value);
    var R_shunt = parseLocalFloat(document.getElementById('gen_R_shunt').value);

    
    if(clicked_measure == 'btn_start_frequency_sweep'){
      
      /* Read the values from input fields */
      
      var fs_step = parseLocalFloat(document.getElementById('gen_fs_step').value);
      var fs_Sfreq = parseLocalFloat(document.getElementById('gen_fs_Sfreq').value);
      var fs_Efreq = parseLocalFloat(document.getElementById('gen_fs_Efreq').value);
      var fs_LoadIm = parseLocalFloat(document.getElementById('gen_fs_LoadIm').value);
      var fs_LoadRe = parseLocalFloat(document.getElementById('gen_fs_LoadRe').value);


      /* Argument check */
      if(amp > 2 || amp <= 0){
        document.getElementById('gen_amp').style.borderColor = "red";
      }
      if(avg < 0){
        document.getElementById('gen_avg').style.borderColor = "red";
      }
      if(dc_bias < 0 || dc_bias > 1){
        document.getElementById('gen_DC_bias').style.borderColor = "red";
        
      }
      if(dc_bias + amp <= 0 || amp + dc_bias > 1){
        document.getElementById('gen_DC_bias').style.borderColor = "red";
        document.getElementById('gen_amp').style.borderColor = "red";
      }
      if(fs_step < 0 || fs_step >  1000){
        document.getElementById('gen_fs_step').style.borderColor = "red";
      }
      if(R_shunt < 0){
        document.getElementById('gen_R_shunt').style.borderColor = "red";
      }
      if(fs_Sfreq < 0 || fs_Sfreq > 100000000){
        document.getElementById('gen_fs_Sfreq').style.borderColor = "red";
      }
      if(fs_Efreq < 0 || fs_Efreq > 100000000 || fs_Efreq < fs_Sfreq){
        document.getElementById('gen_fs_Efreq').style.borderColor = "red";
      }
      if(fs_LoadIm < 0){
        document.getElementById('gen_fs_LoadIm').style.borderColor = "red";
      }
      if(fs_LoadRe < 0){
        document.getElementById('gen_fs_LoadRe').style.borderColor = "red";
      }


      /* End function if input error */
      
      if(document.getElementById('gen_amp').style.borderColor == "red"       ||
         document.getElementById('gen_avg').style.borderColor == "red"       ||
         document.getElementById('gen_DC_bias').style.borderColor == "red"   ||
         document.getElementById('gen_R_shunt').style.borderColor == "red"   ||
         document.getElementById('gen_fs_step').style.borderColor == "red"   ||
         document.getElementById('gen_fs_Sfreq').style.borderColor == "red"  ||
         document.getElementById('gen_fs_Efreq').style.borderColor == "red"  ||
         document.getElementById('gen_fs_LoadRe').style.borderColor == "red" ||
         document.getElementById('gen_fs_LoadIm').style.borderColor == "red"){

        return;
      }


      /* If everything was OK, write data to local params */
      params.local.gen_amp = amp;
      params.local.gen_avg = avg;
      params.local.gen_DC_bias = dc_bias;
      params.local.gen_R_shunt = R_shunt;
      params.local.lcr_steps = fs_step;
      params.local.start_freq = fs_Sfreq;
      params.local.end_freq = fs_Efreq;
      params.local.gen_fs_LoadRe = fs_LoadRe;
      params.local.gen_fs_LoadIm = fs_LoadIm;


      /* Pulling data from dropdown list for Scale type */
      params.local.lcr_scale_type = parseLocalFloat(document.getElementById('apply_gen_fs_scale').value);

      /* Pulling data from dropdown list for calibration type */
      params.local.lcr_calibration = parseLocalFloat(document.getElementById('apply_gen_fs_OSCalib').value);
      /* Start measure */
      params.local.start_measure = 1;
      
      
      
    }else if(clicked_measure == 'btn_start_measurment_sweep'){
      
      /* MS specific parameters */
      var ms_step = parseLocalFloat(document.getElementById('gen_ms_step').value);
      var ms_freq = parseLocalFloat(document.getElementById('gen_ms_freq').value);
      var ms_re = parseLocalFloat(document.getElementById('gen_ms_LoadRe').value);
      var ms_im = parseLocalFloat(document.getElementById('gen_ms_LoadIm').value);


      if(ms_step < 0 || ms_step > 1000){
        document.getElementById('gen_ms_step').style.borderColor = "red";
      }
      if(ms_freq < 0 || ms_freq > 100000000){
        document.getElementById('gen_ms_freq').style.borderColor = "red";
      }
      if(ms_re < 0){
        document.getElementById('gen_ms_LoadRe').style.borderColor = "red";
      }
      if(ms_im < 0){
        document.getElementById('gen_ms_LoadIm').style.borderColor = "red";
      }
      
      /* End function if input error */
      if(document.getElementById('gen_amp').style.borderColor == "red" ||
         document.getElementById('gen_avg').style.borderColor == "red" ||
         document.getElementById('gen_DC_bias').style.borderColor == "red" ||
         document.getElementById('gen_R_shunt').style.borderColor == "red" ||
         document.getElementById('gen_ms_step').style.borderColor == "red" ||
         document.getElementById('gen_ms_freq').style.borderColor == "red" || 
         document.getElementById('gen_ms_LoadRe').style.borderColor == "red" || 
         document.getElementById('gen_ms_LoadIm').style.borderColor == "red"){
          return;
      }
      
      /* Like in FS, if everything was OK, we write it in params */
      params.local.gen_amp = amp;
      params.local.gen_avg = avg;
      params.local.gen_DC_bias = dc_bias;
      params.local.gen_R_shunt = R_shunt;
      params.local.lcr_steps = ms_step;
      params.local.start_freq = ms_freq;
      params.local.end_freq = 100000000;
      params.local.gen_fs_LoadRe = ms_re;
      params.local.gen_fs_LoadIm = ms_im;
      /* Pulling data from dropdown list for Scale type */
      params.local.lcr_scale_type = parseLocalFloat(document.getElementById('apply_gen_ms_scale').value);

      /* Pulling data from dropdown list for calibration type */
      params.local.lcr_calibration = parseLocalFloat(document.getElementById('apply_gen_ms_OSCalib').value);

      params.local.start_measure = 2;
      
    }
    
    lcr_modal.showPleaseWait();
    var hide_channel_lcr = $('#btn_ch1');
    hide_channel_lcr.data('checked', false);

    /* Show tittle for X and Y axis */
    change_Measure = 1;
    params.local.plot_y_scale_data = parseLocalFloat(document.getElementById('apply_Yaxis').value);

    //append_table(10);

    /* Send params to C controller */
    sendParams();
 }

  function changeData(){

    params.local.plot_y_scale_data = parseLocalFloat(document.getElementById('apply_Yaxis').value);

    /* Change the graph X and Y axis */
    change_Measure = 1;
    /* Send params with same measure */
    sendParams();
  }

  $('#pleaseWaitDialog').css({
    'background-image': 'none',
    'background-color': '#D5273A'
    });

  lcr_modal = lcr_modal || (function () {
    var pleaseWaitDiv = $('<div class="modal" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h1>Measuring...</h1></div><div class="modal-body"><div class="progress progress-bar-danger progress-striped active"><div class="bar" style="width: 100%; "></div></div></div></div></div></div>');
    return {
        showPleaseWait: function() {
            pleaseWaitDiv.modal();
        },
        hidePleaseWait: function () {
            pleaseWaitDiv.modal('hide');
        },

    };
  })();

  function hideWaitBar()
  {
    lcr_modal.hidePleaseWait();
  }

  function saveData(){
    params.local.lcr_save_data = 1;

    var amp = parseLocalFloat(document.getElementById('gen_amp').value);
    var avg = parseLocalFloat(document.getElementById('gen_avg').value);
    var dc_bias = parseLocalFloat(document.getElementById('gen_DC_bias').value);
    var R_shunt = parseLocalFloat(document.getElementById('gen_R_shunt').value);

    var fs_Sfreq = parseLocalFloat(document.getElementById('gen_fs_Sfreq').value);
    var fs_Efreq = parseLocalFloat(document.getElementById('gen_fs_Efreq').value);
    var fs_LoadIm = parseLocalFloat(document.getElementById('gen_fs_LoadIm').value);
    var fs_LoadRe = parseLocalFloat(document.getElementById('gen_fs_LoadRe').value);

    params.local.gen_amp = amp;
    params.local.gen_avg = avg;
    params.local.gen_DC_bias = dc_bias;
    params.local.gen_R_shunt = R_shunt;
    params.local.start_freq = fs_Sfreq;
    params.local.end_freq = fs_Efreq;
    params.local.gen_fs_LoadRe = fs_LoadRe;
    params.local.gen_fs_LoadIm = fs_LoadIm;  
      
    sendParams();
  }

  function loadData(){
    /* We want to load all the saved parameters */
    params.local.lcr_save_data = 2;
    sendParams();

  }

  /*
  function append_table(params){
    for(var i=0; i < params; i++){
      var t = document.getElementById('t_measurment_data');
      var tr = document.createElement('tr');
      for(var j=0; j< 15; j++){
        var td = document.createElement('td');
      }
      
      td.innerHTML = t;
      document.getElementById('t_measurment_data').appendChild(tr);
    }
  }
  */
  
  </script>
  <script src="../assets/redpitaya.custom.js"></script>
</head>
<body>
  <div class="header">
    <div class="container">
      <a id="btn_exit" class="pull-left" href="/index.html"><span class="glyphicon glyphicon-chevron-left" title="Exit" alt="Exit"></span></a>
      <img class="logo pull-left" src="../assets/images/logo_white.png">
      <h2 class="page-title">LCR meter</h2>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div id="btn_toolbar" class="col-xs-12">
        <!-- //comment <button id="btn_autoscale_y" class="btn btn-primary btn-lg" data-autozoom="false" onclick="autoscaleY()">
          <span class="glyphicon glyphicon-resize-vertical"></span> Autoscale
        </button>
        <button class="btn btn-primary btn-lg" onclick="resetZoom()">
          <span class="glyphicon glyphicon-retweet"></span> Reset zoom
        </button> --> 
        <div id="selzoompan" class="btn-group" data-toggle="buttons">
          <button id="btn_zoomin" class="btn btn-primary" onclick="selectTool.call(this, 'zoomin')" style="display: none">
            <span class="glyphicon glyphicon-zoom-in"></span>
          </button>
          <button id="btn_zoomout" class="btn btn-default" onclick="selectTool.call(this, 'zoomout')" style="display: none">
            <span class="glyphicon glyphicon-zoom-out"></span>
          </button>
          <button id="btn_pan" class="btn btn-default" onclick="selectTool.call(this, 'pan')" style="display: none">
            <span class="glyphicon glyphicon-move"></span>
          </button>

          <!-- Div for selecting type of data plot -->
          
        </div>

        <div hidden class="btn-group" data-toggle="buttons">
          <!-- Primary data display is going to be amplitude--> 
            
          
          </div>

        


    <div hidden>
        <button hidden id="btn_ch1" class="btn btn-primary btn-lg" data-checked="true" onclick="setVisibleChannels(this)">Channel 1</button>
        <button hidden id="btn_ch2" class="btn btn-primary btn-lg" data-checked="false" onclick="setVisibleChannels(this)">Channel 2</button>
        <button hidden id="btn_auto" class="btn btn-primary btn-lg" onclick="serverAutoScale()">AUTO</button>
        <button hidden id="btn_avg" class="btn btn-default btn-lg" onclick="setAvgAtDec()">Averaging</button>
      </div>
      </div>
    </div>
    <div class="row">
      <div class="col-xs-12 col-sm-12 col-md-8">
        <div class="graph-holder well well-small">
          <div id="ytitle"></div>
          <div id="trigger_cnv_holder">
            <canvas id="trigger_canvas" width="25" height="460"></canvas>
            <div id="trigger_tooltip"></div>
          </div>
          <div id="plot_holder"></div>
          <div id="xtitle"></div>
        </div>  

        <div style="display:none" id="t_measurment_data">
          <table id="measurment_table" style="width:100%" border="1px solid black" border-collapse="collapse" padding="5px">
            <tr>        
              <th id="c_amplitude">Amplitude</th>
              <th id="c_phase">Phase</th>
              <th id="c_y_abs">|Y|</th>
              <th id="c_r_s">Rs</th>
              <th id="c_phaseY">PhaseY</th>
              <th id="c_x_s">Xs</th>
              <th id="c_g_p">Gp</th>
              <th id="c_b_p">Bp</th>
              <th id="c_c_s">Cs</th>
              <th id="c_c_p">Cp</th>
              <th id="c_l_s">Ls</th>
              <th id="c_l_p">Lp</th>
              <th id="c_r_p">Rp</th>
              <th id="c_q">Q</th>
              <th id="c_d">D</th>
            </tr>


        </table><br>
        </div>
      </div>  

      <div class="panel-group col-xs-12 col-sm-12 col-md-4" id="accordion">

        <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#meas_param">
                Measurement parameters
              </a>
            </h4>
          </div>

          <div id="meas_param" class="panel-collapse collapse">

            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label for="gen_amp" class="col-xs-4 control-label">Amplitude:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="number" autocomplete="off" class="form-control" value="1" id="gen_amp">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_amp">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
          <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_amp_unit">V</div>
                </div>
                <div class="form-group">
                  <label for="gen_avg" class="col-xs-4 control-label">Averaging:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="number" autocomplete="off" class="form-control" value="1" id="gen_avg">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_avg">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                </div>
                <div class="form-group">
                  <label for="gen_DC_bias" class="col-xs-4 control-label">DC Bias:</label>
                  <div class="col-xs-4 col-sm-5">
                    <input type="number" autocomplete="off" class="form-control" value="0" id="gen_DC_bias">
                    <span style="display: none;" class="input-group-btn" id="apply_gen_DC_bias">
                      <button type="button" class="btn btn-primary btn-lg"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
          <div style="padding: 7px 0 0;" class="col-xs-2" id="gen_DC_bias_unit">V</div>
                </div>
                <div class="form-group">
                  <label for="gen_R_shunt_label" class="col-xs-4 control-label">R_shunt:</label>
                  <div class="col-xs-5">
                    <input type="number" autocomplete="off" class="form-control" value="1000" id="gen_R_shunt">
                    <span id="apply_gen_R_shunt" class="input-group-btn" style="display: none;">
                      <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                    </span>
                  </div>
                  <div id="R_shunt_units" class="col-xs-3" style="padding: 7px 0 0;">Ω</div>
                </div>
              </form>
            </div>
          </div>
        </div>
    <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#sweep_func">
                Sweep functions
              </a>
            </h4>
          </div>
          <div id="sweep_func" class="panel-collapse collapse">
            <div class="panel-body">
        <form class="form-horizontal" role="form" onsubmit="return false;">
        
          <div class="panel-heading">
            <h4 class="panel-title">
            <a data-toggle="collapse" href="#meas_sweep">
              <b>Measurement sweep</b>
            </a>
          </h4>
          </div>
        <div id="meas_sweep" class="panel-collapse collapse">
                  <div class="form-group">
                    <label for="gen_ms_freq" class="col-xs-4 control-label">Frequency:</label>
                    <div class="col-xs-5">
                      <input type="text" autocomplete="off" class="form-control" value="1000" id="gen_ms_freq">
                      <span id="apply_gen_ms_freq" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                    <div id="freq_units" class="col-xs-3" style="padding: 7px 0 0;">Hz</div>
                  </div>
                  <div class="form-group">
                    <label for="gen_ms_step" class="col-xs-4 control-label">Count:</label>
                    <div class="col-xs-5">
                      <input type="text" autocomplete="off" class="form-control" value="1" id="gen_ms_step">
                      <span id="apply_gen_ms_step" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                  </div>

          <div class="form-group">
            <label for="gen_fs_scale" class="col-xs-4 control-label">Scale:</label>
          <div class="col-xs-4 col-sm-5">
                      <select class="form-control" id="apply_gen_ms_scale">
                        <option value="0">Lin</option>
                        <option value="1">Log</option>
                      </select>
                  </div>
          </div>
          <!--
          <div class="form-group">
            <label for="gen_ms_wait" class="col-xs-4 control-label">Wait:</label>
          <div class="col-xs-4 col-sm-5">
                      <select class="form-control" id="apply_gen_ms_wait">
                        <option value="0">No</option>
                        <option value="1">Yes</option>
                      </select>
                  </div>
          </div>
        -->
          <div class="form-group">
            <label for="gen_fs_OSCalib" class="col-xs-4 control-label">Calibration:</label>
                   <div class="col-xs-4 col-sm-5">
                      <select class="form-control" id="apply_gen_ms_OSCalib">
                        <option value="0">None</option>
                        <option value="1">Open</option>
                        <option value="2">Short</option>
                        <option value="3">Load</option>
                      </select>
                    </div>
          </div>
          <div class="form-group">
                    <label for="gen_fs_LoadReLabel" class="col-xs-4 control-label"> Load Re:</label>
                    <div class="col-xs-5">
                      <input type="number" autocomplete="off" class="form-control" value="0" id="gen_ms_LoadRe">
                      <span id="apply_gen_fs_LoadReLabel" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                    <div id="fs_LoadRe_units" class="col-xs-3" style="padding: 7px 0 0;">Ω</div>
                  </div>
          <div class="form-group">
                    <label for="gen_fs_LoadIm" class="col-xs-4 control-label"> Load Im:</label>
                    <div class="col-xs-5">
                      <input type="number" autocomplete="off" class="form-control" value="0" id="gen_ms_LoadIm">
                      <span id="apply_gen_fs_LoadIm" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                    <div id="fs_LoadIm_units" class="col-xs-3" style="padding: 7px 0 0;">Ω</div>
                  </div>
          <div>
          <button id="btn_start_measurment_sweep" class="btn btn-primary btn-lg" data-checked="true" onclick="startMeasure(this.id)">Start</button>
          </div>
        </div>
        
        <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#freq_sweep">
                <b>Frequency sweep</b>
            </a>
            </h4>
        </div>
        <div id="freq_sweep" class="panel-collapse collapse">
                  <div class="form-group">
                    <label for="gen_fs_Sfreq" class="col-xs-4 control-label">Start frequency:</label>
                    <div class="col-xs-5">
                      <input type="number" autocomplete="off" class="form-control" value="200" id="gen_fs_Sfreq">
                      <span id="apply_gen_fs_Sfreq" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                    <div id="freq_units" class="col-xs-3" style="padding: 7px 0 0;">Hz</div>
                  </div>
          <div class="form-group">
                    <label for="gen_fs_Efreq" class="col-xs-4 control-label">End frequency:</label>
                    <div class="col-xs-5">
                      <input type="number" autocomplete="off" class="form-control" value="10000" id="gen_fs_Efreq">
                      <span id="apply_gen_fs_Efreq" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                    <div id="freq_units" class="col-xs-3" style="padding: 7px 0 0;">Hz</div>
                  </div>
          <div class="form-group">
                    <label for="gen_fs_step" class="col-xs-4 control-label">Step:</label>
                    <div class="col-xs-5">
                      <input type="number" autocomplete="off" class="form-control" value="10" id="gen_fs_step">
                      <span id="apply_gen_fs_step" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                  </div>
          <div class="form-group">
            <label for="gen_fs_scale" class="col-xs-4 control-label">Scale:</label>
          <div class="col-xs-4 col-sm-5">
                      <select class="form-control" id="apply_gen_fs_scale">
                        <option value="0">Lin</option>
                        <option value="1">Log</option>
                      </select>
                  </div>
          </div>
          <div class="form-group">
            <label for="gen_fs_OSCalib" class="col-xs-4 control-label">Calibration:</label>
          <div class="col-xs-4 col-sm-5">
                      <select class="form-control" id="apply_gen_fs_OSCalib">
                        <option value="0">None</option>
                        <option value="1">Open</option>
                        <option value="2">Short</option>
                        <option value="3">Load</option>
                      </select>
                    </div>
          </div>
          
          <div class="form-group">
                    <label for="gen_fs_LoadReLabelFS" class="col-xs-4 control-label"> Load Re:</label>
                    <div class="col-xs-5">
                      <input type="text" autocomplete="off" class="form-control" value="0" id="gen_fs_LoadRe">
                      <span id="apply_gen_fs_LoadReSpan" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                    <div id="fs_LoadRe_units" class="col-xs-3" style="padding: 7px 0 0;">Ω</div>
                  </div>
          <div class="form-group">
                    <label for="gen_fs_LoadImLabel" class="col-xs-4 control-label"> Load Im:</label>
                    <div class="col-xs-5">
                      <input type="text" autocomplete="off" class="form-control" value="0" id="gen_fs_LoadIm">
                      <span id="apply_gen_fs_LoadImSpan" class="input-group-btn" style="display: none;">
                        <button class="btn btn-primary btn-lg" type="button"><span class="glyphicon glyphicon-ok-circle"></span></button>
                      </span>
                    </div>
                    <div id="fs_LoadIm_units" class="col-xs-3" style="padding: 7px 0 0;">Ω</div>
                  </div>
          <div>
          <button id="btn_start_frequency_sweep" class="btn btn-primary btn-lg" data-checked="true" onclick="startMeasure(this.id)">Start</button>
          </div>
        </div>
        
              </form>
            </div>
          </div>
        </div>

    <div class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#plot_meas">
                Plot measurements
              </a>
            </h4>
          </div>
          <div id="plot_meas" class="panel-collapse collapse">
            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">

              <div class="form-group">
                <label for="gen_Xaxis" class="col-xs-4 control-label">X Axis:</label>
                <div class="col-xs-4 col-sm-5">
                        <select class="form-control" id="apply_Xaxis">
                          <option value="0">Frequency</option>
                        </select>
                </div>
              </div>

              <div class="form-group">
                <label for="gen_Yaxis" class="col-xs-4 control-label">Y Axis:</label>
                  <div class="col-xs-4 col-sm-5">
                          <select class="_shunt:form-control" id="apply_Yaxis">
                            <option value="0">|Z|</option>
                            <option value="1">Phase Z</option>
                            <option value="2">|Y|</option>
                            <option value="3">Phase Y</option>
                            <option value="4">Rs</option>
                            <option value="5">Xs</option>
                            <option value="6">Gp</option>
                            <option value="7">Cs</option>
                            <option value="8">Cp</option>
                            <option value="9">Ls</option>
                            <option value="10">Lp</option>
                            <option value="11">Rp</option>
                            <option value="12">Q</option>
                            <option value="13">D</option>
                          </select>
                        </div>
              </div>

              <div>
                <button id="btn_start_plot" class="btn btn-primary btn-lg" data-checked="true" onclick="changeData()">Show plot</button>
              </div>

              </form>
            </div>
          </div>
        </div>

         <div class="panel panel-default">

          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#plot_meas">
                Save parameter data
              </a>
            </h4>
          </div>

          <div id="save_data" class="panel-collapse collapse">
            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">


              <div class="form-group">
                <div><label id="lb_save_data" class="col-xs-4 control-label"><b>Save data</b></label></div>

                <div class="col-xs-5">
                  <button id="bt_save_data" class="btn btn-primary btn-lg" data-checked="true" onclick="saveData()">Save data</button>
                </div>
              </div>

              <div class="form-group">
                <div><label id="lb_load_data" class="col-xs-4 control-label"><b>Load data</b></label></div>

                <div class="col-xs-5">
                  <button id="bt_load_data" class="btn btn-primary btn-lg" data-checked="true" onclick="loadData()">Load data</button>
                </div>
              </div>

              </form>
            </div>
          </div>
        </div>


        <div hidden class="panel panel-default">
          <div class="panel-heading">
            <h4 class="panel-title">
              <a data-toggle="collapse" href="#range">
                Range
              </a>
            </h4>
          </div>
          <div id="range" class="panel-collapse collapse">
            <div class="panel-body">
              <form class="form-horizontal" role="form" onsubmit="return false;">
                <div class="form-group">
                  <label class="col-xs-4 col-sm-3 control-label" style="padding-top: 35px;">Range:</label>
                  <div class="col-xs-8 col-sm-9">
                    <div class="row">
                      <div class="col-xs-6 text-center">
                        <div class="group-label" style="padding-bottom: 10px;">X axis</div>
                        <div class="btn-group" style="margin-bottom: -3px;">
                          <button id="range_x_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
                            <span class="glyphicon glyphicon-minus"></span>
                          </button>
                          <button id="range_x_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
                            <span class="glyphicon glyphicon-plus"></span>
                          </button>
                        </div>
                        <div>
                          <span id="range_x" class="badge range-badge">-</span>
                        </div>
                      </div>
                      <div class="col-xs-6 text-center">
                        <div class="group-label" style="padding-bottom: 10px;">Y axis</div>
                        <div class="btn-group" style="margin-bottom: -3px;">
                          <button id="range_y_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
                            <span class="glyphicon glyphicon-minus"></span>
                          </button>
                          <button id="range_y_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
                            <span class="glyphicon glyphicon-plus"></span>
                          </button>
                        </div>
                        <div>
                          <span id="range_y" class="badge range-badge">-</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-xs-4 col-sm-3 control-label">Offset:</label>
                  <div class="col-xs-8 col-sm-9">
                    <div class="row">
                      <div class="col-xs-6 text-center">
                        <div class="btn-group" style="margin-bottom: -3px;">
                          <button id="offset_x_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
                            <span class="glyphicon glyphicon-minus"></span>
                          </button>
                          <button id="offset_x_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
                            <span class="glyphicon glyphicon-plus"></span>
                          </button>
                        </div>
                      </div>
                      <div class="col-xs-6 text-center">
                        <div class="btn-group" style="margin-bottom: -3px;">
                          <button id="offset_y_minus" type="button" class="btn btn-primary btn-lg range-btn-left">
                            <span class="glyphicon glyphicon-minus"></span>
                          </button>
                          <button id="offset_y_plus" type="button" class="btn btn-primary btn-lg range-btn-right">
                            <span class="glyphicon glyphicon-plus"></span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div> 
      </div>
    </div>
    <div class="footer clearfix">
      <p class="pull-right" style="margin: 4px 0 0">&copy; 2014 - Red Pitaya</p>
    </div>
  </div>

  <!-- Error Modals -->
  <div id="modal_err" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_err_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_err_label">Application error</h4>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default btn-close-modal" id="btn_ignore">Ignore</button>
          <button type="button" class="btn btn-default" id="btn_retry_get">Retry</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal_app" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_app_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_app_label">Application stopped</h4>
        </div>
        <div class="modal-body">
          The <strong><span class="app-id"></span></strong> application was stopped. The current started application is <strong><span id="new_app_id"></span></strong>.<br />
          Do you want to switch to newly started application or to restart <strong><span class="app-id"></span></strong>?
        </div>
        <div class="modal-footer">
          <a href="/index.html" class="btn btn-danger pull-left">Exit app</a>
          <button type="button" class="btn btn-default" id="btn_switch_app">Switch</button>
          <button type="button" class="btn btn-primary btn-app-restart">Restart</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modal_upload" class="modal" tabindex="-1" role="dialog" aria-labelledby="modal_upload_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="modal_upload_label">File upload for channel <span></span></h4>
        </div>
        <div class="modal-body"> 
          <form id="upload_form" role="form">
            <div class="form-group">
              <input type="file" name="file_select" id="uploaded_file">
              <input type="hidden" name="file_content" id="uploaded_file_content">
              <p class="help-block">Select the CSV file to upload.</p>
            </div>
          </form>
        </div>
        <div class="modal-footer" style="margin-top: 0;">
          <button type="button" class="btn btn-default btn-close-modal">Close</button>
          <button type="button" class="btn btn-primary" onclick="startUpload()">Upload</button>
        </div>
      </div>
    </div>
  </div> 


</body>
</html>
